#!/bin/bash

# Retrieve the node identifier from the argument
node_identifier=$(hostname)

# Determine the directory of the current script
script_dir="$(dirname "$(readlink -f "$0")")"

# Source the vars_logging.sh script for logging functions
source "$script_dir/../lib/vars_logging.sh"

# Define the location of the Maldet log file
maldet_log="/usr/local/maldetect/logs/event_log"

# Check if the Maldet log file exists and is readable
if [ ! -f "$maldet_log" ] || [ ! -r "$maldet_log" ]; then
    echo "Maldet log file not found or not readable!"
    exit 1
fi

# Search for any infected file entries in the Maldet log (assuming 'INFECTION' as a keyword)
infected_files=$(grep -i 'INFECTION' "$maldet_log")

# If there are infected files, send a Telegram notification
if [ ! -z "$infected_files" ]; then
    MESSAGE="Node $node_identifier: Malware detected!\nDetails:\n$infected_files"
    $script_dir/../lib/send_telegram_alert.sh "$MESSAGE"
else
    echo "No infections found at this time."
fi